name: Cache Optimization

on:
  schedule:
    # Run daily at 1:00 UTC to warm caches before main work hours
    - cron: '0 1 * * *'
  push:
    branches: [main]
    paths:
      - 'pyproject.toml'
      - 'requirements*.txt'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  warm-pip-cache:
    name: Warm Pip Cache
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/uv
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: Install uv
        run: |
          pip install uv

      - name: Warm cache with dependencies
        run: |
          echo "Warming dependency cache for ${{ runner.os }} Python ${{ matrix.python-version }}"
          uv pip install --system -e ".[dev]" --no-deps --dry-run || true
          uv pip install --system -e ".[dev]"

      - name: Cache summary
        run: |
          echo "### ðŸ’¾ Cache Warmed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
          echo "**Python:** ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ runner.os }}" = "Linux" ]; then
            CACHE_SIZE=$(du -sh ~/.cache/pip 2>/dev/null | cut -f1 || echo "0")
            echo "**Cache size:** $CACHE_SIZE" >> $GITHUB_STEP_SUMMARY
          fi

  warm-test-cache:
    name: Warm Test Cache
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pytest
        uses: actions/cache@v4
        with:
          path: |
            .pytest_cache
            .ruff_cache
            .mypy_cache
          key: pytest-cache-${{ hashFiles('tests/**/*.py') }}

      - name: Install dependencies
        run: |
          pip install uv
          uv pip install --system -e ".[dev]"

      - name: Warm test cache
        run: |
          # Run tests to populate cache but don't fail
          pytest tests/ --collect-only || true

          # Run mypy to populate cache
          mypy cancrizans/ --ignore-missing-imports || true

          # Run ruff to populate cache
          ruff check cancrizans/ || true

      - name: Summary
        run: |
          echo "### âœ… Test Caches Warmed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Pytest cache populated" >> $GITHUB_STEP_SUMMARY
          echo "- Mypy cache populated" >> $GITHUB_STEP_SUMMARY
          echo "- Ruff cache populated" >> $GITHUB_STEP_SUMMARY

  analyze-cache-usage:
    name: Analyze Cache Usage
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Analyze cache effectiveness
        run: |
          echo "### ðŸ“Š Cache Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # This would need GitHub API access to get actual cache stats
          echo "**Cache strategy:**" >> $GITHUB_STEP_SUMMARY
          echo "- pip/uv caches by OS and Python version" >> $GITHUB_STEP_SUMMARY
          echo "- pytest cache by test file hashes" >> $GITHUB_STEP_SUMMARY
          echo "- Tool caches (mypy, ruff) for faster linting" >> $GITHUB_STEP_SUMMARY
          echo "- Docker layer caching with buildx" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Tip:** Caches are automatically warmed daily at 1:00 UTC" >> $GITHUB_STEP_SUMMARY

  optimize-docker-cache:
    name: Optimize Docker Cache
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and cache Docker layers
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: cancrizans:cache

      - name: Summary
        run: |
          echo "### ðŸ³ Docker Cache Optimized" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Docker build layers cached for faster builds" >> $GITHUB_STEP_SUMMARY
