name: Contributor Recognition

on:
  push:
    branches: [main]
  schedule:
    # Run weekly on Sundays at 12:00 UTC
    - cron: '0 12 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-contributors:
    name: Update Contributors
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate contributors list
        run: |
          echo "# Contributors" > CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          echo "Thank you to all the amazing people who have contributed to Cancrizans! ðŸŽ‰" >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md

          # Get all contributors
          git log --format='%aN <%aE>' | sort -u > contributors.txt

          echo "## Code Contributors" >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md

          while IFS= read -r contributor; do
              name=$(echo "$contributor" | sed 's/ <.*//')
              echo "- $name" >> CONTRIBUTORS.md
          done < contributors.txt

          echo "" >> CONTRIBUTORS.md
          echo "---" >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          echo "*This file is automatically generated. Last updated: $(date -u '+%Y-%m-%d %H:%M UTC')*" >> CONTRIBUTORS.md

      - name: Generate contribution statistics
        run: |
          echo "### ðŸ“Š Contribution Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Top contributors by commits
          echo "#### Top 10 Contributors by Commits" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Contributor | Commits | Lines Added | Lines Deleted |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|---------|-------------|---------------|" >> $GITHUB_STEP_SUMMARY

          git log --format='%aN' | sort | uniq -c | sort -rn | head -10 | while read count name; do
              added=$(git log --author="$name" --pretty=tformat: --numstat | awk '{add+=$1} END {print add}')
              deleted=$(git log --author="$name" --pretty=tformat: --numstat | awk '{del+=$2} END {print del}')
              echo "| $name | $count | ${added:-0} | ${deleted:-0} |" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          # Recent contributors (last 30 days)
          echo "#### Recent Contributors (Last 30 Days)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          recent=$(git log --since="30 days ago" --format='%aN' | sort -u | wc -l)
          echo "**Active contributors:** $recent" >> $GITHUB_STEP_SUMMARY

      - name: Commit contributors file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "$(git status --porcelain CONTRIBUTORS.md)" ]; then
            git add CONTRIBUTORS.md
            git commit -m "docs: Update contributors list [skip ci]"
            git push
            echo "âœ… Contributors list updated" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes to contributors list" >> $GITHUB_STEP_SUMMARY
          fi

  thank-contributors:
    name: Thank New Contributors
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Check for first-time contributors
        uses: actions/github-script@v7
        with:
          script: |
            // Get the commits in this push
            const commits = context.payload.commits || [];

            for (const commit of commits) {
              // Get commit details
              const commitData = await github.rest.repos.getCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: commit.sha
              });

              const author = commitData.data.author;
              if (!author) continue;

              // Check if this is their first commit
              const commits = await github.rest.repos.listCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                author: author.login,
                per_page: 2
              });

              if (commits.data.length === 1) {
                // First-time contributor!
                const issueComment = `ðŸŽ‰ **Welcome to Cancrizans, @${author.login}!**

                Thank you for your first contribution! We're excited to have you as part of our community.

                Your contribution has been merged into the main branch. Here are some next steps:

                - â­ Star the repository if you haven't already
                - ðŸ“– Check out our [documentation](docs/)
                - ðŸ’¬ Join discussions in our [Discussions tab](../../discussions)
                - ðŸ› Look for [good first issues](../../issues?q=is%3Aissue+is%3Aopen+label%3A%22good+first+issue%22) to contribute more

                We look forward to your future contributions! ðŸš€`;

                // Find related PR or create a discussion post
                console.log('New contributor detected:', author.login);
              }
            }

  generate-stats:
    name: Generate Repository Stats
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate comprehensive stats
        run: |
          mkdir -p stats

          cat > stats/README.md << 'STATS_EOF'
          # Repository Statistics

          ## Overview

          - **Total Commits:** $(git rev-list --all --count)
          - **Total Contributors:** $(git log --format='%aN' | sort -u | wc -l)
          - **Total Lines of Code:** $(find cancrizans -name '*.py' | xargs wc -l | tail -1 | awk '{print $1}')
          - **Total Tests:** $(find tests -name 'test_*.py' | xargs wc -l | tail -1 | awk '{print $1}')

          ## Activity

          ### Last 30 Days

          - **Commits:** $(git log --since="30 days ago" --oneline | wc -l)
          - **Authors:** $(git log --since="30 days ago" --format='%aN' | sort -u | wc -l)
          - **Files Changed:** $(git log --since="30 days ago" --name-only --pretty=format: | sort -u | wc -l)

          ### Last 7 Days

          - **Commits:** $(git log --since="7 days ago" --oneline | wc -l)
          - **Authors:** $(git log --since="7 days ago" --format='%aN' | sort -u | wc -l)

          ## Code Distribution

          STATS_EOF

          # Add language statistics
          echo "### Languages" >> stats/README.md
          echo "" >> stats/README.md
          echo "\`\`\`" >> stats/README.md
          find . -name '*.py' -o -name '*.ts' -o -name '*.tsx' -o -name '*.js' | \
            xargs wc -l | tail -1 >> stats/README.md
          echo "\`\`\`" >> stats/README.md

          echo "---" >> stats/README.md
          echo "*Generated: $(date -u)*" >> stats/README.md

      - name: Upload stats
        uses: actions/upload-artifact@v4
        with:
          name: repository-stats
          path: stats/
          retention-days: 90
